{ pkgs, lib }:
let
  libPath = with pkgs; lib.makeLibraryPath [
    xorg.libXtst.out
    xorg.libXxf86vm
    libGL
  ];
in
pkgs.stdenv.mkDerivation (with pkgs; rec {
  pname = "behinder";
  version = "4.1";

  nativeBuildInputs = [ makeWrapper ];

  sourceRoot = ".";
  unpackCmd = "${pkgs.unzip}/bin/unzip $src -d behinder";

  dontConfigure = true;
  dontBuild = true;

  installPhase = ''
    runHook preInstall

    mkdir -p $out/share $out/bin
    cp -R behinder $out/share/
    mv $out/share/behinder/data.db $out/share/behinder/data.db.orig
    cat > $out/bin/Behinder << EOF
#!/usr/bin/env bash
DATA_DIR=~/.behinder
WORK_DIR=\$(mktemp -d)
MERGED_DIR=\$(mktemp -d)
if [ ! -d \$DATA_DIR ]; then
  mkdir \$DATA_DIR
  mv $out/share/behinder/data.db.orig \$DATA_DIR/data.db
  chmod u+rw \$DATA_DIR/data.db
fi

${fuse-overlayfs}/bin/fuse-overlayfs -o lowerdir=$out/share/behinder/,upperdir=\$DATA_DIR,workdir=\$WORK_DIR \$MERGED_DIR
cd \$MERGED_DIR

LD_LIBRARY_PATH=${libPath}:''$LD_LIBRARY_PATH \
PATH=${lib.makeBinPath [ jre ]}:''$PATH \
JAVA_HOME=${lib.getBin jre} \
${jre}/bin/java -jar \$MERGED_DIR/Behinder.jar

fusermount -u \$MERGED_DIR
EOF
    chmod +x $out/bin/Behinder
    runHook postInstall
  '';

  src = pkgs.fetchurl {
    url = "https://github.com/rebeyond/Behinder/releases/download/Behinder_v${version}%E3%80%90t00ls%E4%B8%93%E7%89%88%E3%80%91/Behinder_v${version}.t00ls.zip";
    sha256 = "sha256-HpYNTBwA+jCP6dpr+yB2SjecuM9Lh08kVtGZgubGiMI=";
  };

})
