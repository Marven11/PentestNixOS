{ pkgs, lib }:
let

  javafx = pkgs.stdenv.mkDerivation (with pkgs; rec {
    pname = "javafx";
    version = "17.0.12";

    sourceRoot = ".";
    unpackCmd = "${pkgs.unzip}/bin/unzip $src; ls .";

    dontConfigure = true;
    dontBuild = true;


    installPhase = ''
      mkdir $out
      mv javafx-sdk-${version}/legal $out/
      mv javafx-sdk-${version}/lib $out/
      mv javafx-sdk-${version}/src.zip $out/
    '';

    src = pkgs.fetchurl {
      url = "https://download2.gluonhq.com/openjfx/${version}/openjfx-${version}_linux-x64_bin-sdk.zip";
      sha256 = "sha256-+LsnJNJQWV2tVbKIbOqxmoRiUVhj9gmgtUYlKdcl6eg=";
    };

  });
  libPath = with pkgs; lib.makeLibraryPath [
    alsa-lib.out
    at-spi2-atk.out
    cairo.out
    cups.lib
    dbus.lib
    expat.out
    gdk-pixbuf.out
    glib.out
    gtk3.out
    libuuid.lib
    nspr.out
    nss.out
    pango.out
    xorg.libX11.out
    xorg.libXScrnSaver.out
    xorg.libXcomposite.out
    xorg.libXcursor.out
    xorg.libXdamage.out
    xorg.libXext.out
    xorg.libXfixes.out
    xorg.libXi.out
    xorg.libXrandr.out
    xorg.libXrender.out
    xorg.libXtst.out
    xorg.libxcb.out
    javafx
  ];
in
pkgs.stdenv.mkDerivation (with pkgs; rec {
  pname = "shiroattack2";
  version = "4.7.0";

  buildInputs = [ javaPackages.openjfx11 ];

  nativeBuildInputs = [ makeWrapper wrapGAppsHook3 copyDesktopItems gobject-introspection ];

  sourceRoot = ".";
  unpackCmd = "${pkgs.unzip}/bin/unzip $src; ls .";

  dontConfigure = true;
  dontBuild = true;


  installPhase = ''
    runHook preInstall

    mkdir -p $out/share
    cp -R *.jar data/ $out/share/
    echo echo hello > $out/share/test.sh
    chmod +x $out/share/test.sh
    runHook postInstall
  '';


  postFixup = ''
    # Do not create `GPUCache` in current directory
    makeWrapper ${jre}/bin/java $out/bin/ShiroAttack2 \
      --add-flags "--module-path ${javafx}/lib --add-modules javafx.controls,javafx.fxml -jar $out/share/shiro_attack-${version}-SNAPSHOT-all.jar" \
      --prefix LD_LIBRARY_PATH : ${libPath} \
      --prefix PATH : ${lib.makeBinPath [ jre ]} \
      --set JAVA_HOME ${lib.getBin jre} \
      --chdir /tmp \
      "''${gappsWrapperArgs[@]}"
  '';

  src = pkgs.fetchurl {
    url = "https://github.com/SummerSec/ShiroAttack2/releases/download/${version}/shiro_attack-${version}-SNAPSHOT-all.zip";
    sha256 = "sha256-bwDqVNjH84eBA2GrxCvfjJ8PzRywLsjw6HPvtYUXgFg=";
  };

})
